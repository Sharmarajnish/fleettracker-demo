name: Security Scan

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # Run security scans weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'

jobs:
  # Run Precogs AI security scanner
  precogs-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Precogs AI Scanner
        uses: precogs-ai/scan-action@v1
        with:
          api-key: ${{ secrets.PRECOGS_API_KEY }}
          fail-on-critical: true
          fail-on-high: false
          scan-depth: full
          output-format: sarif
        continue-on-error: true
      
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: precogs-results.sarif
        continue-on-error: true
      
      - name: Upload scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: precogs-scan-results
          path: |
            precogs-report.json
            precogs-results.sarif
          retention-days: 30

  # Run CodeQL analysis
  codeql-analysis:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  # Run npm audit for dependency vulnerabilities
  dependency-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --json > npm-audit.json || true
      
      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: npm-audit.json
          retention-days: 30

  # Secret scanning (basic check for hardcoded secrets)
  secret-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true  # Repo intentionally has hardcoded secrets for demo

  # Create PR comment with security summary
  pr-comment:
    runs-on: ubuntu-latest
    needs: [precogs-scan, codeql-analysis, dependency-audit]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Precogs results
        uses: actions/download-artifact@v4
        with:
          name: precogs-scan-results
        continue-on-error: true
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let report = { critical: 'N/A', high: 'N/A', medium: 'N/A', low: 'N/A' };
            try {
              report = JSON.parse(fs.readFileSync('precogs-report.json', 'utf8'));
            } catch (e) {
              console.log('Could not read Precogs report');
            }
            
            const criticalBadge = report.critical > 0 ? 'üî¥' : 'üü¢';
            const highBadge = report.high > 0 ? 'üü†' : 'üü¢';
            
            const comment = `## üîí Security Scan Results
            
            | Severity | Count |
            |----------|-------|
            | ${criticalBadge} Critical | ${report.critical} |
            | ${highBadge} High | ${report.high} |
            | üü° Medium | ${report.medium} |
            | üîµ Low | ${report.low} |
            
            ### Intentional Vulnerabilities (Demo Application)
            
            | CWE ID | Vulnerability | Location |
            |--------|---------------|----------|
            | CWE-89 | SQL Injection | \`/api/vehicles/search\`, \`/api/vehicles/filter\`, \`/api/reports/*\` |
            | CWE-78 | Command Injection | \`/api/export/*\`, \`/api/files/process\` |
            | CWE-22 | Path Traversal | \`/api/files/:filename\`, \`/api/files/document/*\` |
            | CWE-502 | Insecure Deserialization | \`/api/session/*\` |
            | CWE-287 | Improper Authentication | JWT with weak secret, no expiry |
            | CWE-798 | Hard-coded Credentials | \`db.js\`, \`auth.js\` |
            | CWE-862 | Missing Authorization | \`DELETE /api/vehicles/:id\` |
            | CWE-778 | Insufficient Logging | Auth failure logging missing |
            | CVE-2025-55182 | React2Shell | \`/dashboard/[id]/page.js\` |
            
            ---
            ‚ö†Ô∏è **Warning**: This is a demo application with intentional vulnerabilities. Do not deploy to production!`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
